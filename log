-- ===============================
-- NOSALT LOGGER | ROBLOX CLIENT
-- FIXED VERSION (NO BindToClose)
-- ===============================

-- HTTP WRAPPER
local http =
    request or
    http_request or
    (syn and syn.request) or
    (fluxus and fluxus.request)

if not http then
    warn("[nosalt] Executor has no http support")
    return
end

-- SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- ===============================
-- CONFIG (ของคุณตรง ๆ)
-- ===============================
local API_URL = "https://lt-log-dusfaaq.replit.app/apilog"
local HEARTBEAT_INTERVAL = 5

-- ===============================
-- IDENTITIES
-- ===============================
local PC_NAME = tostring(getgenv().PC_NAME or "PC_DEFAULT")
local PC_ID = tostring(game.JobId)
local CLIENT_ID = tostring(player.UserId)

-- ===============================
-- SEND FUNCTION
-- ===============================
local function sendLog(message, extra)
    local payload = {
        pc_id = PC_ID,
        pc_name = PC_NAME,
        client_id = CLIENT_ID,
        player_name = player.Name,
        place_id = game.PlaceId,
        job_id = game.JobId,
        message = message,
        extra = extra or {},
        timestamp = os.time()
    }

    pcall(function()
        http({
            Url = API_URL,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode(payload)
        })
    end)
end

-- ===============================
-- CONNECT
-- ===============================
sendLog("Connected")

-- ===============================
-- HEARTBEAT (ONLINE STATUS)
-- ===============================
local alive = true

task.spawn(function()
    while alive do
        task.wait(HEARTBEAT_INTERVAL)
        sendLog("Still Alive")
    end
end)

-- ===============================
-- DISCONNECT DETECT
-- ===============================
player.AncestryChanged:Connect(function(_, parent)
    if not parent then
        alive = false
        sendLog("Disconnected")
    end
end)

-- ===============================
-- FAILSAFE (EXECUTOR STOP / TELEPORT)
-- ===============================
RunService.Heartbeat:Connect(function()
    if not player or not player.Parent then
        alive = false
    end
end)

-- ===============================
-- DEBUG
-- ===============================
print("[nosalt] Logger loaded | PC:", PC_NAME)