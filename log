-- =====================================================
-- NOSALT | HERMANOS STYLE LOGGER
-- =====================================================

local http = request or http_request or syn.request
if not http then
    warn("[nosalt] Executor has no http support")
    return
end

-- SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- CONFIG (API URL ของคุณ)
local API_URL = "https://nosalt-log.dusfaaq.repl.co/apilog"

-- IDENTITIES
local PC_NAME = tostring(getgenv().PC_NAME or "PC_DEFAULT")
local PC_ID = tostring(game.JobId)
local USERNAME = player.Name
local USER_ID = tostring(player.UserId)

-- STATE
local lastSeed = 0
local lastPing = 0

-- SAFE NUMBER
local function toNumber(v)
    if not v then return 0 end
    local n = tonumber(tostring(v):gsub(",", ""))
    return n or 0
end

-- GET SEED
local function getSeed()
    local stats = player:FindFirstChild("leaderstats")
    if not stats then return lastSeed end

    for _,v in pairs(stats:GetChildren()) do
        if v.Name:lower():find("seed") then
            return toNumber(v.Value)
        end
    end
    return lastSeed
end

-- SEND LOG
local function send(type, data)
    http({
        Url = API_URL,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode({
            pc_name = PC_NAME,
            pc_id = PC_ID,
            username = USERNAME,
            user_id = USER_ID,
            seed = lastSeed,
            type = type,
            data = data,
            time = os.time()
        })
    })
end

-- CONNECT
send("connect", "Connected")

-- HEARTBEAT
task.spawn(function()
    while true do
        send("heartbeat", "Still Alive")
        task.wait(5)
    end
end)

-- SEED WATCHER
task.spawn(function()
    while true do
        local seed = getSeed()
        if seed ~= lastSeed then
            lastSeed = seed
            send("seed", seed)
        end
        task.wait(2)
    end
end)

-- DISCONNECT
game:BindToClose(function()
    send("disconnect", "Left Game")
end)