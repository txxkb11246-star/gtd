-- ===============================
-- NOSALT LOGGER | ROBLOX CLIENT
-- ===============================

-- HTTP WRAPPER (รองรับหลาย executor)
local http =
    request or
    http_request or
    (syn and syn.request) or
    (fluxus and fluxus.request)

if not http then
    warn("[nosalt] Executor has no http support")
    return
end

-- SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- ===============================
-- CONFIG (ใช้ของคุณตรง ๆ)
-- ===============================
local API_URL = "https://lt-log-dusfaaq.replit.app/apilog"
local HEARTBEAT_INTERVAL = 5

-- ===============================
-- IDENTITIES
-- ===============================
local PC_NAME = tostring(getgenv().PC_NAME or "PC_DEFAULT")
local PC_ID = tostring(game.JobId)
local CLIENT_ID = tostring(player.UserId)

-- ===============================
-- SEND FUNCTION
-- ===============================
local function sendLog(message, extra)
    local payload = {
        pc_id = PC_ID,
        pc_name = PC_NAME,
        client_id = CLIENT_ID,
        player_name = player.Name,
        place_id = game.PlaceId,
        job_id = game.JobId,
        message = message,
        extra = extra or {},
        timestamp = os.time()
    }

    local ok, err = pcall(function()
        http({
            Url = API_URL,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode(payload)
        })
    end)

    if not ok then
        warn("[nosalt] Send failed:", err)
    end
end

-- ===============================
-- CONNECT LOG
-- ===============================
sendLog("Connected")

-- ===============================
-- HEARTBEAT (Still Alive)
-- ===============================
task.spawn(function()
    while task.wait(HEARTBEAT_INTERVAL) do
        sendLog("Still Alive")
    end
end)

-- ===============================
-- PLAYER EVENTS
-- ===============================
player.AncestryChanged:Connect(function(_, parent)
    if not parent then
        sendLog("Disconnected")
    end
end)

-- ===============================
-- GAME CLOSE
-- ===============================
game:BindToClose(function()
    sendLog("Game Closing")
    task.wait(1)
end)

-- ===============================
-- DEBUG CONFIRM
-- ===============================
print("[nosalt] Logger loaded | PC:", PC_NAME)