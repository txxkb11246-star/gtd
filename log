-- =====================================
-- NOSALT LOG | ROBLOX CLIENT (FULL)
-- =====================================

-- ===== EXECUTOR HTTP =====
local http = request or http_request or (syn and syn.request)
if not http then
    warn("[nosalt] Executor has no http support")
    return
end

-- ===== SERVICES =====
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer

-- ===== CONFIG =====
local API_URL = "https://YOUR-REPLIT-URL/api/log"
local HEARTBEAT_INTERVAL = 5

-- ===== IDENTITIES =====
local PC_NAME = tostring(getgenv().PC_NAME or "PC_DEFAULT")
local PC_ID = tostring(game.JobId)
local CLIENT_ID = tostring(player.UserId .. "_" .. math.random(1000,9999))

-- ===== SAFE NUMBER =====
local function toNumber(v)
    v = tostring(v):gsub(",", "")
    local n = tonumber(v)
    if not n or n ~= n then return 0 end
    return n
end

-- ===== FIND SEED LABEL SAFELY =====
local function findSeedLabel()
    local gui = player:FindFirstChild("PlayerGui")
    if not gui then return nil end

    for _,v in ipairs(gui:GetDescendants()) do
        if v:IsA("TextLabel") then
            if string.find(v.Text, "Seed") or string.find(v.Name, "Seed") then
                return v
            end
        end
    end
    return nil
end

-- ===== SEND TO SERVER =====
local function send(payload)
    payload.pc_id = PC_ID
    payload.pc_name = PC_NAME
    payload.client = CLIENT_ID
    payload.username = player.Name
    payload.time = os.time()

    local ok, err = pcall(function()
        http({
            Url = API_URL,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode(payload)
        })
    end)

    if not ok then
        warn("[nosalt] Send failed:", err)
    end
end

-- ===== CONNECT EVENT =====
send({
    type = "connect"
})

print("[nosalt] Connected | PC:", PC_NAME, "| Client:", CLIENT_ID)

-- ===== SEED WATCHER =====
task.spawn(function()
    local label = nil
    local lastSeed = 0

    while true do
        task.wait(1)

        if not label then
            label = findSeedLabel()
            continue
        end

        local current = toNumber(label.Text)
        if current ~= lastSeed then
            local delta = current - lastSeed
            lastSeed = current

            send({
                type = "seed",
                seed = current,
                delta = delta
            })
        end
    end
end)

-- ===== HEARTBEAT =====
task.spawn(function()
    while true do
        task.wait(HEARTBEAT_INTERVAL)
        send({
            type = "heartbeat"
        })
    end
end)

-- ===== DISCONNECT =====
game:BindToClose(function()
    send({
        type = "disconnect"
    })
end)