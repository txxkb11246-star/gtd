-- =====================================
-- NOSALT LOG | ROBLOX CLIENT (FINAL)
-- =====================================

-- ===== HTTP (executor) =====
local http =
    request or
    http_request or
    (syn and syn.request) or
    (fluxus and fluxus.request)

if not http then
    warn("[nosalt] Executor has no http support")
    return
end

-- ===== SERVICES =====
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer

-- ===== CONFIG =====
local API_URL = "https://lt-log-dusfaaq.replit.app/apilog"
local HEARTBEAT = 5

-- ===== IDENTITIES =====
local PC_NAME = tostring(getgenv().PC_NAME or "PC_DEFAULT")
local PC_ID = tostring(game.JobId)
local CLIENT_ID = tostring(player.UserId .. "_" .. math.random(1000,9999))

-- ===== FIND SEED LABEL (ของคุณจริง) =====
local function getSeedLabel()
    return player.PlayerGui
        :WaitForChild("GameGui")
        :WaitForChild("Screen")
        :WaitForChild("Bottom")
        :WaitForChild("CurrencyDisplay")
        :WaitForChild("SeedsDisplay")
        :WaitForChild("Title")
end

local seedLabel = getSeedLabel()

local function parseSeed(text)
    text = tostring(text):gsub(",", "")
    return tonumber(text) or 0
end

-- ===== SEND =====
local function send(payload)
    payload.pc_id = PC_ID
    payload.pc_name = PC_NAME
    payload.client_id = CLIENT_ID
    payload.username = player.Name
    payload.time = os.time()

    pcall(function()
        http({
            Url = API_URL,
            Method = "POST",
            Headers = {["Content-Type"]="application/json"},
            Body = HttpService:JSONEncode(payload)
        })
    end)
end

-- ===== START =====
local lastSeed = parseSeed(seedLabel.Text)

send({
    type = "connect",
    seed = lastSeed,
    delta = 0
})

-- ===== SEED CHANGE (หัวใจระบบ) =====
seedLabel:GetPropertyChangedSignal("Text"):Connect(function()
    local current = parseSeed(seedLabel.Text)
    if current ~= lastSeed then
        send({
            type = "seed",
            seed = current,
            delta = current - lastSeed
        })
        lastSeed = current
    end
end)

-- ===== HEARTBEAT (ONLINE) =====
task.spawn(function()
    while true do
        task.wait(HEARTBEAT)
        send({
            type = "heartbeat",
            seed = lastSeed,
            delta = 0
        })
    end
end)

-- ===== DISCONNECT DETECT =====
player.AncestryChanged:Connect(function(_, parent)
    if not parent then
        send({
            type = "disconnect",
            seed = lastSeed,
            delta = 0
        })
    end
end)

print("[nosalt] Loaded | PC:", PC_NAME, "| Seed:", lastSeed)