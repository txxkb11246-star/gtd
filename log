-- =====================================================
-- NOSALT LOG | ROBLOX CLIENT (FULL VERSION)
-- =====================================================

-- HTTP support
local http = request or http_request or syn.request
if not http then
    warn("[nosalt] Executor has no HTTP support")
    return
end

-- Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- ===== CONFIG (ของคุณจริง) =====
local API_URL = "https://nosalt-log--dusfaaq.replit.app/api/log"

-- ===== IDENTITY =====
local PC_NAME = tostring(getgenv().PC_NAME or "PC_DEFAULT")
local PC_ID = tostring(game.JobId)
local CLIENT_ID = tostring(player.UserId)
local USERNAME = player.Name

-- ===== STATE =====
local lastSeed = 0
local running = true

-- ===== UTILS =====
local function toNumber(v)
    if not v then return 0 end
    return tonumber(tostring(v):gsub(",", "")) or 0
end

-- ===== GET SEED =====
local function getSeed()
    -- leaderstats
    local stats = player:FindFirstChild("leaderstats")
    if stats then
        for _,v in pairs(stats:GetChildren()) do
            if v.Name:lower():find("seed") then
                return toNumber(v.Value)
            end
        end
    end

    -- attribute fallback
    if workspace:GetAttribute("Seed") then
        return toNumber(workspace:GetAttribute("Seed"))
    end

    return lastSeed
end

-- ===== SEND LOG =====
local function send(action, seed)
    local body = {
        pc_id = PC_ID,
        pc_name = PC_NAME,
        client = CLIENT_ID,
        username = USERNAME,
        seed = seed or lastSeed,
        action = action,
        time = os.time()
    }

    pcall(function()
        http({
            Url = API_URL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode(body)
        })
    end)
end

-- ===== START =====
send("CONNECT", lastSeed)

-- HEARTBEAT
task.spawn(function()
    while running do
        send("HEARTBEAT", lastSeed)
        task.wait(5)
    end
end)

-- SEED WATCHER
task.spawn(function()
    while running do
        local s = getSeed()
        if s ~= lastSeed then
            lastSeed = s
            send("SEED_UPDATE", lastSeed)
        end
        task.wait(1)
    end
end)

-- DISCONNECT
game:BindToClose(function()
    running = false
    send("DISCONNECT", lastSeed)
    task.wait(1)
end)

warn("[nosalt] Started | PC:", PC_NAME, "| User:", USERNAME)